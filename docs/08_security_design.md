# セキュリティ設計書

| 項目 | 内容 |
|------|------|
| システム名 | お天気チェッカー（Weather App） |
| バージョン | 1.0 |
| 作成日 | 2026-02-17 |

---

## 1. セキュリティ方針

本アプリケーションは以下の方針に基づいてセキュリティを設計する。

1. **認証の外部委託:** ユーザー認証はGoogle OAuth 2.0に委託し、パスワードを自前で管理しない
2. **機密情報の環境変数管理:** APIキー・シークレット等を環境変数で管理し、コードに直書きしない
3. **サーバーサイドでのAPIキー保護:** 外部APIキーはNext.jsのAPIルート（サーバーサイド）のみで使用し、クライアントに漏洩させない
4. **最小権限の原則:** Supabase Anonキーを使用し、必要最小限の操作権限のみを付与する
5. **HTTPS通信の強制:** 本番環境ではHTTPS通信のみを許可する

---

## 2. 認証・認可設計

### 2.1 認証方式

| 項目 | 内容 |
|------|------|
| 認証方式 | Google OAuth 2.0 |
| ライブラリ | Auth.js（next-auth v5 beta） |
| セッション管理 | Auth.jsのデフォルトセッション（JWT or Database） |
| セッションシークレット | `AUTH_SECRET`環境変数で管理 |

### 2.2 認可制御

**ミドルウェアによるページ保護:**

```typescript
// middleware.ts
export default auth  // 未認証の場合は自動的に / にリダイレクト

export const config = {
  matcher: ["/home/:path*"],  // /home 配下を一括保護
}
```

**サーバーコンポーネントでの二重チェック:**

```typescript
// 各保護ページで個別に認証チェック
const session = await auth()
if (!session) redirect("/")
```

**保護対象と非保護対象:**

| パス | 保護 | 理由 |
|------|------|------|
| `/` | なし | ログインページ |
| `/home` | 認証必須 | ミドルウェア + ページレベル |
| `/mypage` | 認証必須 | ページレベルのみ |
| `/api/*` | なし | 内部API（現バージョン） |

---

## 3. APIキー管理

### 3.1 環境変数一覧とスコープ

| 変数名 | 公開範囲 | 説明 |
|--------|---------|------|
| `APIKEY` | サーバーのみ | OpenWeatherMap APIキー |
| `SUPABASE_URL` | サーバーのみ | SupabaseプロジェクトURL |
| `SUPABASE_ANON_KEY` | サーバーのみ | Supabase Anonキー |
| `GOOGLE_CLIENT_ID` | サーバーのみ | Google OAuthクライアントID |
| `GOOGLE_CLIENT_SECRET` | サーバーのみ | Google OAuthクライアントシークレット |
| `AUTH_SECRET` | サーバーのみ | NextAuthセッション暗号化キー |
| `NEXT_PUBLIC_SITE_URL` | **公開（クライアント可）** | サイトベースURL |
| `GEMINI_API_KEY` | サーバーのみ | Gemini APIキー |

> **重要:** `NEXT_PUBLIC_` プレフィックスが付いた変数はクライアントサイドに露出する。APIキーには絶対に `NEXT_PUBLIC_` を付けないこと。

### 3.2 APIキーの利用場所

| APIキー | 利用ファイル | クライアント露出 |
|---------|------------|----------------|
| `APIKEY` | `app/api/weather/route.ts`<br>`app/api/weather/current/route.ts` | なし（サーバーのみ） |
| `SUPABASE_URL` / `SUPABASE_ANON_KEY` | `app/api/city/route.ts` | なし（サーバーのみ） |
| `GOOGLE_CLIENT_ID/SECRET` | `auth.ts` | なし（サーバーのみ） |
| `AUTH_SECRET` | `auth.ts`（暗黙） | なし |
| `GEMINI_API_KEY` | `app/api/ai-comment/route.ts` | なし（サーバーのみ） |

---

## 4. 通信セキュリティ

### 4.1 HTTPS

| 環境 | 状態 |
|------|------|
| 開発環境（localhost） | HTTP（開発用のため許容） |
| 本番環境（Vercel等） | HTTPS強制 |

Geolocation APIはHTTPSまたはlocalhostでのみ動作するため、本番環境では必ずHTTPSを使用すること。

### 4.2 外部API通信

すべての外部API通信はサーバーサイドのAPIルートを経由する。クライアントが直接外部APIを叩く実装は行っていない。

```
[ブラウザ] → [Next.js API Route] → [外部API]
                （サーバーサイド）
```

---

## 5. 入力値検証

### 5.1 APIルートでの検証

| エンドポイント | 検証内容 | 検証箇所 |
|--------------|---------|---------|
| `GET /api/weather` | `city`パラメータの存在チェック | `if (!city) return 400` |
| `GET /api/weather/current` | `lat`・`lon`の存在チェック | `if (!lat \|\| !lon) return 400` |
| `POST /api/ai-comment` | `weather`・`temp`の存在チェック | `if (!weather \|\| temp === undefined) return 400` |

### 5.2 現在の未対応事項と対策案

| リスク | 現状 | 対策案 |
|--------|------|--------|
| APIルートへの不正アクセス | 認証なし | セッション確認の追加（`auth()`呼び出し） |
| cityパラメータのインジェクション | OpenWeatherMapのAPIが適切にエスケープ | URLエンコードの明示的な実施 |
| lat/lonの数値検証 | 文字列のまま渡している | `parseFloat()`でのバリデーション追加 |
| AIプロンプトインジェクション | ユーザー入力がプロンプトに含まれる | 都市名が既存リストから選択されるため低リスク |

---

## 6. データ保護

### 6.1 保存データとその保護方針

| データ種別 | 保存場所 | 保護方法 |
|-----------|---------|---------|
| ユーザー認証情報 | Google側で管理 | Googleに委任 |
| セッショントークン | Auth.js（Cookie） | `AUTH_SECRET`で署名・暗号化 |
| 都市マスタデータ | Supabase | RLSでSELECTのみ許可 |
| APIキー | `.env.local` | Gitに含まない・サーバーのみ参照 |
| 天気データ | 保存なし（都度取得） | - |
| AIコメント | 保存なし（都度生成） | - |

### 6.2 .gitignore設定

```
# 環境変数ファイル（これらは絶対にコミットしない）
.env
.env.local
.env.*.local
```

---

## 7. セキュリティチェックリスト

### 開発時の確認事項

- [ ] `.env.local` が `.gitignore` に含まれていることを確認
- [ ] APIキーをコード内に直書きしていないことを確認
- [ ] `NEXT_PUBLIC_` プレフィックスを必要な変数にのみ使用していることを確認
- [ ] クライアントコンポーネントから `@/auth` を直接importしていないことを確認
- [ ] 保護ページで `auth()` によるセッションチェックを実施していることを確認

### デプロイ時の確認事項

- [ ] 本番環境の環境変数がすべて設定されていることを確認
- [ ] `AUTH_SECRET` が本番用に新たに生成されていることを確認
- [ ] Google Cloud ConsoleのOAuthリダイレクトURIに本番URLが追加されていることを確認
- [ ] SupabaseのRLSが有効であることを確認
- [ ] HTTPSが有効であることを確認

---

## 8. インシデント対応

### 8.1 APIキー漏洩時の対応手順

1. **即時対応:** 漏洩したAPIキーを各サービスのコンソールで無効化・再生成
2. **調査:** Gitの履歴にキーが含まれていないか確認（含まれていた場合はリポジトリの書き直しまたは全コミット履歴のパージを検討）
3. **新キーの設定:** `.env.local`および本番環境の環境変数を更新
4. **再デプロイ:** 新しいキーを反映してアプリを再デプロイ
5. **影響確認:** 不正利用がなかったか各サービスのログを確認

### 8.2 不正アクセス検知時の対応

1. Vercel / ホスティングサービスのアクセスログを確認
2. 不審なIPアドレスからのアクセスがあればホスティングサービスのファイアウォール設定でブロック
3. `AUTH_SECRET`を再生成して全セッションを無効化

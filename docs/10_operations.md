# 運用保守設計書

| 項目 | 内容 |
|------|------|
| システム名 | お天気チェッカー（Weather App） |
| バージョン | 1.0 |
| 作成日 | 2026-02-17 |

---

## 1. 運用概要

### 1.1 システム運用方針

| 項目 | 内容 |
|------|------|
| 運用形態 | クラウドホスティング（Vercel推奨）によるSaaS運用 |
| 稼働時間 | 24時間365日（外部サービスの可用性に依存） |
| 担当者 | 開発者兼任（小規模アプリケーション） |
| 監視方式 | Vercelダッシュボード + 外部サービスのステータスページ確認 |

### 1.2 依存する外部サービスと可用性

| サービス | 用途 | ステータスページ | SLA |
|---------|------|---------------|-----|
| Vercel | ホスティング | https://www.vercel-status.com | 99.99% |
| OpenWeatherMap | 天気データ | https://status.openweathermap.org | Free Tier依存 |
| Google Gemini API | AI機能 | https://status.cloud.google.com | Google Cloud SLA |
| Supabase | DB | https://status.supabase.com | 99.9%（Pro） |
| Google OAuth | 認証 | https://www.google.com/appsstatus | 99.9%+ |

---

## 2. デプロイ・リリース管理

### 2.1 ブランチ戦略

```
main ─── 本番環境（Vercel自動デプロイ）
  └── dev ─── 開発・テスト用ブランチ
        └── feature/* ─── 機能追加用ブランチ
```

| ブランチ | 用途 | Vercelデプロイ |
|---------|------|--------------|
| `main` | 本番リリース | 自動デプロイ |
| `dev` | 開発・確認 | Preview URL |
| `feature/*` | 機能開発 | Preview URL |

### 2.2 リリース手順

1. `feature/*` ブランチで開発
2. `dev` ブランチへマージ（Preview URLで動作確認）
3. 動作確認後、`main` ブランチへマージ
4. Vercelが自動的に本番環境へデプロイ
5. 本番URLで最終確認

### 2.3 ロールバック手順

Vercelダッシュボードから以下の手順でロールバック：

1. Vercelダッシュボードの「Deployments」タブを開く
2. ロールバック先のデプロイメントを選択
3. 「Redeploy」ボタンをクリック
4. 動作確認

---

## 3. 監視・アラート設計

### 3.1 モニタリング項目

| 監視項目 | 確認方法 | 確認頻度 |
|---------|---------|---------|
| アプリの稼働状態 | Vercelダッシュボード | 障害発生時 |
| APIレスポンスエラー | Vercelのfunction logs | 障害発生時 |
| 外部サービスの状態 | 各サービスのステータスページ | 障害発生時 |
| 月次API利用量 | OpenWeatherMap / Google Cloud Console | 月1回 |

### 3.2 Vercelログの確認方法

```
Vercelダッシュボード
  → 対象プロジェクト
  → Logs タブ
  → Function Logsでエラーを確認
```

### 3.3 エラーログのパターンと対応

| ログ内容 | 原因 | 対応 |
|---------|------|------|
| `Gemini APIキーが設定されていません` | 環境変数未設定 | Vercelの環境変数を確認・設定 |
| `AI生成に失敗しました` | Gemini API呼び出しエラー | Google Cloud Consoleでエラーログを確認 |
| `サーバーエラーが発生しました` | 予期しないエラー | Vercelのfunction logsでスタックトレースを確認 |
| `環境変数が足りません` | Supabase URLまたはキー未設定 | 環境変数を確認 |

---

## 4. 定期メンテナンス

### 4.1 月次確認事項

| 項目 | 内容 |
|------|------|
| APIの利用量確認 | OpenWeatherMap（月1,000,000回制限）・Gemini API（コスト確認） |
| 依存パッケージの脆弱性確認 | `npm audit` を実行 |
| Supabaseの使用量確認 | ストレージ・DB容量の確認 |

### 4.2 四半期確認事項

| 項目 | 内容 |
|------|------|
| 依存パッケージのアップデート | `npm outdated` で確認後、慎重にアップデート |
| Auth.jsのバージョン確認 | next-auth@betaは更新が頻繁なため注意 |
| Google OAuthのポリシー確認 | Google Cloud ConsoleのOAuth同意画面の有効期限確認 |

### 4.3 年次確認事項

| 項目 | 内容 |
|------|------|
| APIキーのローテーション | セキュリティ維持のためAPIキーを再生成 |
| `AUTH_SECRET`の更新 | 全ユーザーのセッションが強制ログアウトになるため、メンテナンスウィンドウを設けて実施 |
| ドメイン・SSL証明書の確認 | 独自ドメイン使用時は有効期限を確認 |

---

## 5. 障害対応フロー

### 5.1 障害検知から復旧まで

```
1. 障害の検知
   ├── ユーザーからの報告
   └── 定期確認時に発見

2. 初期調査（5分以内）
   ├── Vercelのデプロイ状態を確認
   ├── 外部サービスのステータスページを確認
   └── Vercelのfunction logsでエラーを確認

3. 原因切り分け
   ├── アプリ側の問題 → コード修正・再デプロイ
   ├── 環境変数の問題 → Vercel環境変数を修正
   ├── 外部API障害 → サービス復旧を待つ
   └── ホスティング障害 → Vercelの復旧を待つ

4. 復旧対応
   ├── コード修正が必要な場合 → 緊急PRをmainへマージ
   ├── 設定の問題 → Vercelダッシュボードで設定変更
   └── 外部依存の場合 → 各サービスのステータス更新を待機

5. 復旧確認
   └── 本番環境でエンドツーエンドの動作確認
```

### 5.2 障害レベルとSLA目標

| レベル | 内容 | 目標復旧時間 |
|--------|------|------------|
| 高 | ログインできない・全機能停止 | 2時間以内 |
| 中 | AI機能が動作しない | 24時間以内 |
| 低 | 一部の表示崩れ・軽微な不具合 | 次回リリース時 |

---

## 6. 容量・コスト管理

### 6.1 現在の利用コスト（目安）

| サービス | プラン | 月額コスト |
|---------|-------|----------|
| Vercel | Hobby（無料） | $0 |
| OpenWeatherMap | Free | $0（制限あり） |
| Supabase | Free | $0（制限あり） |
| Google Gemini API | Pay-as-you-go | 利用量に応じる |
| Google OAuth | 無料 | $0 |

### 6.2 スケールアップの目安

| トリガー | 対応 |
|---------|------|
| 月間天気API呼び出しが80万回を超える | OpenWeatherMapの有料プランへ移行 |
| Supabaseのストレージが490MBを超える | Supabase Proプランへ移行 |
| Vercelのサーバーレス関数実行時間が制限に近づく | Vercel Proプランへ移行 |

---

## 7. データ管理・バックアップ

### 7.1 バックアップ方針

| データ | バックアップ方法 | 頻度 |
|--------|--------------|------|
| citiesテーブル | Supabaseの自動バックアップ（Free: 1日1回、7日保持） | 自動 |
| ソースコード | Gitリポジトリ | コミット毎 |
| 環境変数 | パスワードマネージャー等に別途保管 | 設定変更時 |

### 7.2 環境変数のバックアップ

`.env.local` はGitに含まれないため、以下のいずれかの方法で別途保管する：

- パスワードマネージャー（1Password、Bitwarden等）
- 暗号化されたプライベートノート

---

## 8. 保守作業の記録

保守作業を実施した際は以下のフォーマットで記録することを推奨する。

| 日付 | 作業内容 | 担当者 | 影響 | 備考 |
|------|---------|--------|------|------|
| 2026-02-17 | 初回デプロイ | - | 全体 | - |

---

## 9. 今後の拡張・改善ロードマップ

| 優先度 | 項目 | 概要 |
|--------|------|------|
| 高 | テスト自動化 | Jest + Playwrightによる自動テスト導入 |
| 高 | エラーモニタリング | Sentry等のエラートラッキングツール導入 |
| 中 | APIルートの認証 | セッション確認を内部APIにも追加 |
| 中 | お気に入り都市機能 | Supabaseに`user_favorites`テーブルを追加 |
| 中 | 週間予報機能 | OpenWeatherMap 5day forecast APIの利用 |
| 低 | プッシュ通知 | Webプッシュ通知による天気アラート |
| 低 | パフォーマンス最適化 | Lighthouseスコアの改善（画像最適化等） |
